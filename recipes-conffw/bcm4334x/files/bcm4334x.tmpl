{{$factory_conf := "/factory/device/wifi"}}
{{$common_conf := "/common/device/wifi"}}
{{$local_conf := "/local/device/wifi"}}

{{$factory_defs := getv $factory_conf "{}"}}
{{$common_defs := getv $common_conf "{}"}}
{{$local_defs := getv $local_conf "{}"}}

{{define "ModprobeEdit"}}
    {{$opmode := .}}
    {{$modprobe := split (mustInclude "/etc/modprobe.d/bcm4334x.conf") "\n"}}

    {{range $idx, $line := $modprobe}}
        {{if regMatch $line "(options[ \t]+bcm4334x)"}}
    	    {{if contains $line "op_mode="}}
                {{regReplace $line "(op_mode=[0-9]+)" (printf "op_mode=%s" $opmode)}}
	    {{else}}
		{{print $line " op_mode=" $opmode}}
	    {{end}}
        {{else}}
	    {{$line}}
	{{end}}
    {{end}}
{{end}}

{{$defs := merge $factory_defs $common_defs $local_defs}}
{{$mode := stringValue $defs.Mode}}

{{if or (eq $mode "AccessPoint") (eq $mode "Tether")}}
    {{template "ModprobeEdit" "2"}}
{{else}}
    {{template "ModprobeEdit" "0"}}
{{end}}
