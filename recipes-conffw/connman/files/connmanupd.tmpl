{{$factory_conf := "/factory/device/wifi"}}
{{$common_conf := "/common/device/wifi"}}
{{$local_conf := "/local/device/wifi"}}

{{$factory_defs := getv $factory_conf "{}"}}
{{$common_defs := getv $common_conf "{}"}}
{{$local_defs := getv $local_conf "{}"}}

{{$defs := merge $factory_defs $common_defs $local_defs}}

{{define "IPv4"}}
    {{$defs := .}}
            "IPv4": {
    {{if eq (stringValue $defs) "DHCP"}}
                "Method": "dhcp"
    {{else}}
                 "Method": "manual",
	         "Address": "{{$defs.IPAddress}}",
	         "Netmask": "{{$defs.SubnetMask}}",
	         "Gateway": "{{$defs.Gateway}}"
    {{end}}
            },
{{end}}

{{define "Security"}}
    {{$defs := .}}
    {{with $Mode := .Mode}}
            "Security": {
        {{$mode := toLower $Mode}}
	{{if eq $mode "none"}}
	        "Mode": "none"
	{{else if eq $mode "wep"}}
	    {{with $key := $defs.WEPKey}}
	            "Mode": "wep",
		    "Passphrase": {{$key}}
	    {{end}}
	{{else if contains $mode "wpa"}}
	    {{if contains $mode "private"}}
	        {{with $psk := $defs.PreSharedKey}}
		    "Mode": "psk",
		    "Passphrase": "{{$psk}}"
		{{end}}
	    {{else}}
	    {{end}}
	{{end}}
                },
    {{end}}
{{end}}

{{define "Visible"}}
            "Hidden": {{not .}}
{{end}}

{{with $Mode := $defs.Mode}}
    {
        "WiFi": {
            "Valid": true,
            "Enable": {{stringValue $defs.Enable "false"}},
            "Name": "{{stringValue $defs.Name ""}}",
	    "Tether": {{if ne $Mode "EndPoint"}}true{{else}}false{{end}},
	    {{template "IPv4" $defs.IPv4}}
	    {{template "Security" $defs.Security}}
	    "Connect": "auto",
	    "Hidden": false
        }
    }
{{end}}
